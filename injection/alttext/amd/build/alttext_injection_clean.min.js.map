{"version":3,"file":"alttext_injection_clean.min.js","sources":["../src/alttext_injection_clean.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AI Alt Text injection module.\n *\n * This module provides functionality to inject AI-powered alt text generation\n * buttons into TinyMCE image dialogs and automatically process images.\n *\n * @module     aiinjection_alttext/alttext_injection\n * @copyright  2025 ISB Bayern\n * @author     Dr. Peter Mayer\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Log from 'core/log';\nimport {makeRequest} from 'local_ai_manager/make_request';\n\n/**\n * Initialize the AI alt text injection.\n *\n * @param {Object} config Configuration object\n * @param {boolean} config.enabled Whether the injection is enabled\n * @param {string} config.selector CSS selector for images to process\n * @param {boolean} config.debug Debug mode\n */\nexport const init = (config) => {\n    const initializeApp = () => {\n        if (config.enabled) {\n            processImages(config);\n        }\n        initModalObserver(config);\n    };\n\n    // Initialize when DOM is ready\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', initializeApp);\n    } else {\n        initializeApp();\n    }\n};\n\n/**\n * Helper function to find element using multiple selectors.\n *\n * @param {Element} parent Parent element to search in\n * @param {string[]} selectors Array of CSS selectors to try\n * @returns {Element|null} Found element or null\n */\nconst findElement = (parent, selectors) => {\n    for (const selector of selectors) {\n        const element = parent.querySelector(selector);\n        if (element) {\n            return element;\n        }\n    }\n    return null;\n};\n\n/**\n * Initialize DOM observer to detect TinyMCE image modals.\n *\n * @param {Object} config Configuration object\n */\nconst initModalObserver = (config) => {\n    // Check if modal is already open\n    checkForImageModal(document, config);\n\n    const observer = new MutationObserver((mutations) => {\n        mutations.forEach((mutation) => {\n            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {\n                mutation.addedNodes.forEach((node) => {\n                    if (node.nodeType === Node.ELEMENT_NODE) {\n                        checkForImageModal(node, config);\n                    }\n                });\n            }\n        });\n    });\n\n    observer.observe(document.body, {\n        childList: true,\n        subtree: true\n    });\n};\n\n/**\n * Check if a DOM node contains the TinyMCE image modal elements.\n *\n * @param {Element} node The DOM node to check\n * @param {Object} config Configuration object\n */\nconst checkForImageModal = (node, config) => {\n    // Look for alt textarea using multiple selectors\n    const altTextareaSelectors = [\n        '#_tiny_image_altentry.tiny_image_altentry',\n        '#_tiny_image_altentry',\n        'textarea[name=\"altentry\"]',\n        'textarea.tiny_image_altentry'\n    ];\n\n    const altTextarea = findElement(node, altTextareaSelectors);\n\n    if (altTextarea) {\n        // Find the right column using multiple selectors\n        const rightColumnSelectors = [\n            '.tiny_image_properties_col',\n            '.col-lg-5',\n            '[class*=\"properties\"]'\n        ];\n\n        const rightColumn = findElement(node, rightColumnSelectors);\n\n        if (rightColumn) {\n            // Small delay to ensure all modal elements are loaded\n            setTimeout(() => injectAIButton(rightColumn, altTextarea, config), 100);\n        }\n    }\n};\n\n/**\n * Inject the AI alttext generation button into the modal.\n *\n * @param {Element} rightColumn The right column container\n * @param {Element} altTextarea The alt text textarea element\n * @param {Object} config Configuration object\n */\nconst injectAIButton = (rightColumn, altTextarea, config) => {\n    // Check if button already exists\n    if (rightColumn.querySelector('.ai-alttext-button')) {\n        return;\n    }\n\n    // Find image preview using multiple selectors\n    const imageSelectors = [\n        '.tiny_image_preview',\n        'img[src*=\"draftfile\"]',\n        '.tiny_image_preview_box img',\n        '.tox-dialog img',\n        '[role=\"dialog\"] img',\n        '.mce-window img'\n    ];\n\n    const imagePreview = findElement(document, imageSelectors);\n\n    if (!imagePreview?.src) {\n        return;\n    }\n\n    // Create button elements\n    const buttonContainer = document.createElement('div');\n    buttonContainer.className = 'ai-alttext-container mb-3 mt-3';\n\n    const aiButton = document.createElement('button');\n    Object.assign(aiButton, {\n        type: 'button',\n        className: 'btn btn-secondary ai-alttext-button',\n        innerHTML: '<i class=\"fa fa-magic me-1\"></i> KI-Bildbeschreibung generieren'\n    });\n\n    // Add click handler\n    aiButton.addEventListener('click', async (event) => {\n        event.preventDefault();\n        await handleAIButtonClick(aiButton, altTextarea, imagePreview, config);\n    });\n\n    buttonContainer.appendChild(aiButton);\n    rightColumn.appendChild(buttonContainer);\n};\n\n/**\n * Handle the AI button click event.\n *\n * @param {Element} button The AI button element\n * @param {Element} textarea The alt text textarea\n * @param {Element} imageElement The image preview element\n * @param {Object} config Configuration object\n */\nconst handleAIButtonClick = async (button, textarea, imageElement, config) => {\n    // Show loading state\n    const originalText = button.innerHTML;\n    button.disabled = true;\n    button.innerHTML = '<i class=\"fa fa-spinner fa-spin me-1\"></i> Generiere Beschreibung...';\n\n    try {\n        // Generate alt text using the image element directly\n        const altText = await generateAltText(imageElement);\n\n        if (altText) {\n            // Set the generated text in the textarea\n            textarea.value = altText;\n\n            // Trigger input event to update character counter\n            textarea.dispatchEvent(new Event('input', { bubbles: true }));\n\n            if (config.debug) {\n                Log.debug('Alt text generated and inserted:', altText);\n            }\n        } else {\n            // Show user-friendly error message\n            alert('Fehler beim Generieren der Bildbeschreibung. Bitte versuchen Sie es erneut.');\n        }\n    } catch (error) {\n        if (config.debug) {\n            Log.error('Error generating alt text:', error);\n        }\n        alert('Fehler beim Generieren der Bildbeschreibung: ' + error.message);\n    } finally {\n        // Restore button state\n        button.disabled = false;\n        button.innerHTML = originalText;\n    }\n};\n\n/**\n * Process images and add alt text using AI.\n *\n * @param {Object} config Configuration object\n */\nconst processImages = (config) => {\n    const images = document.querySelectorAll(config.selector);\n\n    if (config.debug) {\n        Log.debug(`Found ${images.length} images to process`);\n    }\n\n    images.forEach((img, index) => {\n        // Add a small delay between requests to avoid overwhelming the AI service\n        setTimeout(() => {\n            processImage(img, config);\n        }, index * 500);\n    });\n};\n\n/**\n * Process a single image.\n *\n * @param {HTMLImageElement} img The image element\n * @param {Object} config Configuration object\n */\nconst processImage = async (img, config) => {\n    try {\n        img.setAttribute('data-ai-alttext-status', 'loading');\n\n        const altText = await generateAltText(img);\n\n        if (altText) {\n            img.alt = altText;\n            img.setAttribute('data-ai-alttext-status', 'completed');\n            if (config.debug) {\n                Log.debug(`Generated alt text for ${img.src}: ${altText}`);\n            }\n        } else {\n            img.setAttribute('data-ai-alttext-status', 'failed');\n        }\n    } catch (error) {\n        img.setAttribute('data-ai-alttext-status', 'error');\n        if (config.debug) {\n            Log.error('Error processing image:', error);\n        }\n    }\n};\n\n/**\n * Convert image element to base64 data URL.\n *\n * @param {HTMLImageElement} imageElement The image element\n * @returns {Promise<string>} Base64 data URL\n */\nconst imageToBase64 = async (imageElement) => {\n    return new Promise((resolve, reject) => {\n        try {\n            const canvas = document.createElement('canvas');\n            const ctx = canvas.getContext('2d');\n\n            // Handle CORS and loading\n            const img = new Image();\n            img.crossOrigin = 'anonymous';\n\n            img.onload = () => {\n                canvas.width = img.naturalWidth || img.width;\n                canvas.height = img.naturalHeight || img.height;\n\n                ctx.drawImage(img, 0, 0);\n\n                try {\n                    // Use JPEG format with good compression for AI analysis\n                    const dataURL = canvas.toDataURL('image/jpeg', 0.8);\n                    resolve(dataURL);\n                } catch (error) {\n                    Log.error('Canvas toDataURL error:', error);\n                    reject(error);\n                }\n            };\n\n            img.onerror = (error) => {\n                Log.error('Image load error:', error);\n                reject(error);\n            };\n\n            // Use the source from the image element\n            img.src = imageElement.src;\n\n        } catch (error) {\n            Log.error('Canvas creation error:', error);\n            reject(error);\n        }\n    });\n};\n\n/**\n * Generate alt text for an image using AI service.\n *\n * @param {HTMLImageElement} imageElement The image element\n * @returns {Promise<string|null>} The generated alt text or null if failed\n */\nconst generateAltText = async (imageElement) => {\n    try {\n        // Convert image to base64\n        const imageBase64 = await imageToBase64(imageElement);\n\n        // Create prompt optimized for alt text generation\n        const prompt = `Generiere einen pr채zisen deutschen Alt-Text f체r das Bild. ` +\n                      `Beschreibe kurz und sachlich was auf dem Bild zu sehen ist. ` +\n                      `Der Alt-Text soll f체r sehbehinderte Personen verst채ndlich sein.`;\n\n        // Send request with image data according to AI Manager conventions\n        // The itt purpose expects an 'image' parameter with base64 data\n        const result = await makeRequest('itt', prompt, 'aiinjection_alttext', 0, {\n            image: imageBase64\n        });\n\n        // Handle array response structure\n        let responseData = result;\n        if (Array.isArray(result) && result.length > 0) {\n            responseData = result[0];\n        }\n\n        // Extract text from response data\n        let altText = null;\n\n        // Check for error first\n        if (responseData && responseData.error === true) {\n            Log.error('AI Manager returned error:', responseData);\n            return null;\n        }\n\n        // Extract result text from successful response\n        if (responseData && responseData.data && responseData.data.result) {\n            // Remove HTML tags and get clean text\n            const htmlResult = responseData.data.result;\n            const tempDiv = document.createElement('div');\n            tempDiv.innerHTML = htmlResult;\n            altText = tempDiv.textContent || tempDiv.innerText || '';\n            altText = altText.trim();\n        } else if (responseData && responseData.result) {\n            // Alternative structure - sometimes result is directly available\n            const htmlResult = responseData.result;\n            const tempDiv = document.createElement('div');\n            tempDiv.innerHTML = htmlResult;\n            altText = tempDiv.textContent || tempDiv.innerText || '';\n            altText = altText.trim();\n        }\n\n        return altText || null;\n    } catch (error) {\n        Log.error('Error in generateAltText (AI manager):', error);\n        return null;\n    }\n};"],"names":["config","initializeApp","enabled","processImages","initModalObserver","document","readyState","addEventListener","findElement","parent","selectors","selector","element","querySelector","checkForImageModal","MutationObserver","mutations","forEach","mutation","type","addedNodes","length","node","nodeType","Node","ELEMENT_NODE","observe","body","childList","subtree","altTextarea","rightColumn","setTimeout","injectAIButton","imagePreview","src","buttonContainer","createElement","className","aiButton","Object","assign","innerHTML","async","event","preventDefault","handleAIButtonClick","appendChild","button","textarea","imageElement","originalText","disabled","altText","generateAltText","value","dispatchEvent","Event","bubbles","debug","alert","error","message","images","querySelectorAll","img","index","processImage","setAttribute","alt","imageBase64","Promise","resolve","reject","canvas","ctx","getContext","Image","crossOrigin","onload","width","naturalWidth","height","naturalHeight","drawImage","dataURL","toDataURL","onerror","imageToBase64","prompt","result","image","responseData","Array","isArray","data","htmlResult","tempDiv","textContent","innerText","trim"],"mappings":";;;;;;;;;;;kJAsCqBA,eACXC,cAAgB,KACdD,OAAOE,SACPC,cAAcH,QAElBI,kBAAkBJ,SAIM,YAAxBK,SAASC,WACTD,SAASE,iBAAiB,mBAAoBN,eAE9CA,uBAWFO,YAAc,CAACC,OAAQC,iBACpB,MAAMC,YAAYD,UAAW,OACxBE,QAAUH,OAAOI,cAAcF,aACjCC,eACOA,eAGR,MAQLR,kBAAqBJ,SAEvBc,mBAAmBT,SAAUL,QAEZ,IAAIe,kBAAkBC,YACnCA,UAAUC,SAASC,WACO,cAAlBA,SAASC,MAAwBD,SAASE,WAAWC,OAAS,GAC9DH,SAASE,WAAWH,SAASK,OACrBA,KAAKC,WAAaC,KAAKC,cACvBX,mBAAmBQ,KAAMtB,iBAOpC0B,QAAQrB,SAASsB,KAAM,CAC5BC,WAAW,EACXC,SAAS,KAUXf,mBAAqB,CAACQ,KAAMtB,gBASxB8B,YAActB,YAAYc,KAPH,CACzB,4CACA,wBACA,4BACA,oCAKAQ,YAAa,OAQPC,YAAcvB,YAAYc,KANH,CACzB,6BACA,YACA,0BAKAS,aAEAC,YAAW,IAAMC,eAAeF,YAAaD,YAAa9B,SAAS,OAYzEiC,eAAiB,CAACF,YAAaD,YAAa9B,aAE1C+B,YAAYlB,cAAc,mCAcxBqB,aAAe1B,YAAYH,SATV,CACnB,sBACA,wBACA,8BACA,kBACA,sBACA,uBAKC6B,MAAAA,eAAAA,aAAcC,iBAKbC,gBAAkB/B,SAASgC,cAAc,OAC/CD,gBAAgBE,UAAY,uCAEtBC,SAAWlC,SAASgC,cAAc,UACxCG,OAAOC,OAAOF,SAAU,CACpBpB,KAAM,SACNmB,UAAW,sCACXI,UAAW,oEAIfH,SAAShC,iBAAiB,SAASoC,MAAAA,QAC/BC,MAAMC,uBACAC,oBAAoBP,SAAUT,YAAaI,aAAclC,WAGnEoC,gBAAgBW,YAAYR,UAC5BR,YAAYgB,YAAYX,kBAWtBU,oBAAsBH,MAAOK,OAAQC,SAAUC,aAAclD,gBAEzDmD,aAAeH,OAAON,UAC5BM,OAAOI,UAAW,EAClBJ,OAAON,UAAY,iFAITW,cAAgBC,gBAAgBJ,cAElCG,SAEAJ,SAASM,MAAQF,QAGjBJ,SAASO,cAAc,IAAIC,MAAM,QAAS,CAAEC,SAAS,KAEjD1D,OAAO2D,oBACHA,MAAM,mCAAoCN,UAIlDO,MAAM,+EAEZ,MAAOC,OACD7D,OAAO2D,oBACHE,MAAM,6BAA8BA,OAE5CD,MAAM,gDAAkDC,MAAMC,iBAG9Dd,OAAOI,UAAW,EAClBJ,OAAON,UAAYS,eASrBhD,cAAiBH,eACb+D,OAAS1D,SAAS2D,iBAAiBhE,OAAOW,UAE5CX,OAAO2D,oBACHA,sBAAeI,OAAO1C,8BAG9B0C,OAAO9C,SAAQ,CAACgD,IAAKC,SAEjBlC,YAAW,KACPmC,aAAaF,IAAKjE,UACX,IAARkE,WAULC,aAAexB,MAAOsB,IAAKjE,cAEzBiE,IAAIG,aAAa,yBAA0B,iBAErCf,cAAgBC,gBAAgBW,KAElCZ,SACAY,IAAII,IAAMhB,QACVY,IAAIG,aAAa,yBAA0B,aACvCpE,OAAO2D,oBACHA,uCAAgCM,IAAI9B,iBAAQkB,WAGpDY,IAAIG,aAAa,yBAA0B,UAEjD,MAAOP,OACLI,IAAIG,aAAa,yBAA0B,SACvCpE,OAAO2D,oBACHE,MAAM,0BAA2BA,SA0D3CP,gBAAkBX,MAAAA,yBAGV2B,iBAlDQ3B,OAAAA,cACX,IAAI4B,SAAQ,CAACC,QAASC,oBAEfC,OAASrE,SAASgC,cAAc,UAChCsC,IAAMD,OAAOE,WAAW,MAGxBX,IAAM,IAAIY,MAChBZ,IAAIa,YAAc,YAElBb,IAAIc,OAAS,KACTL,OAAOM,MAAQf,IAAIgB,cAAgBhB,IAAIe,MACvCN,OAAOQ,OAASjB,IAAIkB,eAAiBlB,IAAIiB,OAEzCP,IAAIS,UAAUnB,IAAK,EAAG,aAIZoB,QAAUX,OAAOY,UAAU,aAAc,IAC/Cd,QAAQa,SACV,MAAOxB,oBACDA,MAAM,0BAA2BA,OACrCY,OAAOZ,SAIfI,IAAIsB,QAAW1B,qBACPA,MAAM,oBAAqBA,OAC/BY,OAAOZ,QAIXI,IAAI9B,IAAMe,aAAaf,IAEzB,MAAO0B,oBACDA,MAAM,yBAA0BA,OACpCY,OAAOZ,WAce2B,CAActC,cAGlCuC,OAAS,wLAMTC,aAAe,6BAAY,MAAOD,OAAQ,sBAAuB,EAAG,CACtEE,MAAOrB,kBAIPsB,aAAeF,OACfG,MAAMC,QAAQJ,SAAWA,OAAOrE,OAAS,IACzCuE,aAAeF,OAAO,QAItBrC,QAAU,QAGVuC,eAAuC,IAAvBA,aAAa/B,0BACzBA,MAAM,6BAA8B+B,cACjC,QAIPA,cAAgBA,aAAaG,MAAQH,aAAaG,KAAKL,OAAQ,OAEzDM,WAAaJ,aAAaG,KAAKL,OAC/BO,QAAU5F,SAASgC,cAAc,OACvC4D,QAAQvD,UAAYsD,WACpB3C,QAAU4C,QAAQC,aAAeD,QAAQE,WAAa,GACtD9C,QAAUA,QAAQ+C,YACf,GAAIR,cAAgBA,aAAaF,OAAQ,OAEtCM,WAAaJ,aAAaF,OAC1BO,QAAU5F,SAASgC,cAAc,OACvC4D,QAAQvD,UAAYsD,WACpB3C,QAAU4C,QAAQC,aAAeD,QAAQE,WAAa,GACtD9C,QAAUA,QAAQ+C,cAGf/C,SAAW,KACpB,MAAOQ,2BACDA,MAAM,yCAA0CA,OAC7C"}