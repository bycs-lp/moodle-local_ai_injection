{"version":3,"file":"alttext_injection.min.js","sources":["../src/alttext_injection.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Ultra-optimized AI Alt Text injection for Tiny Media modals.\n *\n * @module     aiinjection_alttext/alttext_injection\n * @copyright  2025 ISB Bayern\n * @author     Dr. Peter Mayer\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Log from 'core/log';\nimport {getString} from 'core/str';\nimport {makeRequest} from 'local_ai_manager/make_request';\nimport Templates from 'core/templates';\n\nlet debugMode = false;\n\n/**\n * Convert image to base64\n * @param {string} imageUrl Image URL to convert\n * @returns {Promise<string>} Promise resolving to base64 data URL\n */\nconst imageToBase64 = (imageUrl) => new Promise((resolve, reject) => {\n    const img = new Image();\n    img.crossOrigin = 'anonymous';\n    img.onload = () => {\n        const canvas = document.createElement('canvas');\n        const ctx = canvas.getContext('2d');\n        canvas.width = img.naturalWidth || img.width;\n        canvas.height = img.naturalHeight || img.height;\n        ctx.drawImage(img, 0, 0);\n        resolve(canvas.toDataURL('image/jpeg', 0.8));\n    };\n    img.onerror = () => reject(new Error('Image load failed'));\n    img.src = imageUrl;\n});\n\n/**\n * Extract alt text from AI response\n * @param {Object} data Response data from AI service\n * @returns {string|null} Extracted alt text or null\n */\nconst extractAltText = (data) => {\n    if (data?.error) {\n        return null;\n    }\n    const result = data?.result || data?.data?.result;\n    if (!result) {\n        return null;\n    }\n\n    let text = result.replace(/<[^>]*>/g, '').trim();\n    try {\n        text = JSON.parse('\"' + text.replace(/\"/g, '\\\\\"') + '\"');\n    } catch (e) {\n        // Use original if JSON parsing fails\n    }\n    return text || null;\n};\n\n/**\n * Generate alt text using AI service\n * @param {string} imageUrl Image URL to process\n * @returns {Promise<string|null>} Generated alt text or null\n */\nconst generateAltText = async(imageUrl) => {\n    try {\n        const [imageBase64, prompt] = await Promise.all([\n            imageToBase64(imageUrl),\n            getString('aiprompt', 'aiinjection_alttext')\n        ]);\n\n        const result = await makeRequest('itt', prompt, 'aiinjection_alttext', 0, {image: imageBase64});\n        if (debugMode) {\n            Log.debug('AI response:', result);\n        }\n\n        return extractAltText(Array.isArray(result) ? result[0] : result);\n    } catch (error) {\n        Log.error('AI generation failed:', error);\n        return null;\n    }\n};\n\n/**\n * Button click handler\n * @param {Event} event Click event\n */\nconst handleButtonClick = async (event) => {\n    event.preventDefault();\n    const button = event.target;\n    const modal = button.closest(\".modal\");\n    const textarea = modal.querySelector(\".tiny_image_altentry\");\n    const image = modal.querySelector(\".tiny_image_preview\");\n\n    if (!textarea || !image?.src || image.src === \"data:,\") {\n        return;\n    }\n\n    // Show loading state via template\n    await injectButton(modal, {isloading: true});\n\n    try {\n        const altText = await generateAltText(image.src);\n        if (altText) {\n            textarea.value = altText;\n            textarea.dispatchEvent(new Event(\"input\", { bubbles: true }));\n            textarea.dispatchEvent(new Event(\"change\", { bubbles: true }));\n            if (debugMode) {\n                Log.debug(\"Alt text inserted:\", altText);\n            }\n        }\n    } catch (error) {\n        Log.error(\"Button click error:\", error);\n    }\n\n    // Reset to normal state via template\n    await injectButton(modal, {isloading: false});\n};\n\n/**\n * Inject AI button into modal\n * @param {HTMLElement} modal Modal element to inject button into\n * @param {Object} templateContext Context object for template rendering (optional)\n */\nconst injectButton = async(modal, templateContext = {}) => {\n    const countspan = modal.querySelector(\"#the-count\");\n    if (!countspan) {\n        return;\n    }\n\n    let button = modal.querySelector(\".ai-alttext-btn\");\n    if (button) {\n        button.remove();\n    }\n\n    // Render Mustache-Template with context\n    const {html, js} = await Templates.renderForPromise('aiinjection_alttext/ai_button_container', templateContext);\n    countspan.insertAdjacentHTML(\"afterend\", html);\n    if (js) {\n        Templates.runTemplateJS(js);\n    }\n\n    // Event Listener fÃ¼r den Button\n    button = modal.querySelector('.ai-alttext-btn');\n    if (button) {\n        button.addEventListener('click', handleButtonClick);\n    }\n\n    if (debugMode) {\n        Log.debug('AI button injected via template', templateContext);\n    }\n};\n\n/**\n * Initialize MutationObserver for modal detection\n */\nconst initModalObserver = () => {\n    const observer = new MutationObserver((mutations) => {\n        mutations.forEach((mutation) => {\n            mutation.addedNodes.forEach((node) => {\n                if (node.nodeType === Node.ELEMENT_NODE) {\n                    // Check if added node is a modal with tiny_image_altentry\n                    if (node.classList?.contains('modal') && node.querySelector('.tiny_image_altentry')) {\n                        setTimeout(() => injectButton(node), 100);\n                    }\n                    // Check if added node contains a modal with tiny_image_altentry\n                    const modal = node.querySelector?.('.modal .tiny_image_altentry');\n                    if (modal) {\n                        const modalElement = modal.closest('.modal');\n                        if (modalElement) {\n                            setTimeout(() => injectButton(modalElement), 100);\n                        }\n                    }\n                }\n            });\n        });\n    });\n\n    observer.observe(document.body, {\n        childList: true,\n        subtree: true\n    });\n\n    if (debugMode) {\n        Log.debug('Modal observer initialized');\n    }\n};\n\n/**\n * Initialize AI alt text injection\n * @param {Object} config Configuration options\n * @param {boolean} config.debug Enable debug mode\n */\nexport const init = (config = {}) => {\n    debugMode = config.debug || false;\n\n    if (debugMode) {\n        Log.debug('Initializing ultra-optimized AI alt text injection', config);\n    }\n\n    // Use robust MutationObserver approach\n    initModalObserver();\n\n    // Also check existing modals on page load\n    setTimeout(() => {\n        const existingModals = document.querySelectorAll('.modal .tiny_image_altentry');\n        existingModals.forEach(textarea => {\n            const modal = textarea.closest('.modal');\n            if (modal) {\n                injectButton(modal);\n            }\n        });\n    }, 500);\n\n    if (debugMode) {\n        Log.debug('AI alt text injection initialized');\n    }\n};\n"],"names":["debugMode","imageToBase64","imageUrl","Promise","resolve","reject","img","Image","crossOrigin","onload","canvas","document","createElement","ctx","getContext","width","naturalWidth","height","naturalHeight","drawImage","toDataURL","onerror","Error","src","generateAltText","async","imageBase64","prompt","all","result","image","debug","data","error","_data$data","text","replace","trim","JSON","parse","e","extractAltText","Array","isArray","handleButtonClick","event","preventDefault","modal","target","closest","textarea","querySelector","injectButton","isloading","altText","value","dispatchEvent","Event","bubbles","templateContext","countspan","button","remove","html","js","Templates","renderForPromise","insertAdjacentHTML","runTemplateJS","addEventListener","initModalObserver","MutationObserver","mutations","forEach","mutation","addedNodes","node","nodeType","Node","ELEMENT_NODE","classList","contains","setTimeout","_node$querySelector","modalElement","observe","body","childList","subtree","config","querySelectorAll"],"mappings":"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"}