{"version":3,"file":"alttext_injection.min.js","sources":["../src/alttext_injection.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Ultra-optimized AI Alt Text injection for Tiny Media modals.\n *\n * @module     aiinjection_alttext/alttext_injection\n * @copyright  2025 ISB Bayern\n * @author     Dr. Peter Mayer\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Log from 'core/log';\nimport {getString} from 'core/str';\nimport {alert as moodleAlert} from 'core/notification';\nimport {makeRequest} from 'local_ai_manager/make_request';\nimport Templates from 'core/templates';\nimport Config from 'core/config';\n\n/** @type {WeakSet} Track modals that have been initialized to prevent duplicate listeners */\nconst initializedModals = new WeakSet();\n\n/** @type {Object|null} Store AI configuration passed from PHP */\nlet aiConfig = null;\n\n/** @type {number} Context ID for AI requests, passed from PHP */\nlet contextId = 0;\n\n/** @type {string} Prompt template from PHP with {LANGUAGE} placeholder */\nlet promptTemplate = '';\n\n/**\n * Get current user language name in English.\n *\n * Uses Intl.DisplayNames to get the language name in English based on Moodle's Config.language.\n *\n * @returns {string} User's current language name in English (e.g., 'German', 'French')\n */\nconst getCurrentLanguage = () => {\n    const currentUserLanguage = Config.language.substring(0, 2);\n    const englishDisplayNames = new Intl.DisplayNames(['en'], {type: 'language'});\n    return englishDisplayNames.of(currentUserLanguage) || 'English';\n};\n\n/**\n * Check if AI purpose is disabled.\n *\n * @returns {boolean} True if purpose is disabled\n */\nconst isPurposeDisabled = () => {\n    if (!aiConfig?.purposes?.[0]) {\n        return false;\n    }\n    return aiConfig.purposes[0].available === 'disabled';\n};\n\n/**\n * Get disabled reason message.\n *\n * @returns {string|null} Disabled reason or null\n */\nconst getDisabledReason = () => {\n    if (!isPurposeDisabled()) {\n        return null;\n    }\n    return aiConfig.purposes[0].disabledreason || null;\n};\n\n/**\n * Convert image to base64 using fetch and FileReader.\n *\n * Uses fetch to retrieve the image as a blob and FileReader to convert to base64.\n * This approach avoids canvas CORS issues and is more reliable for cross-origin images.\n *\n * @param {string} imageUrl Image URL to convert\n * @returns {Promise<string>} Promise resolving to base64 data URL\n */\nconst imageToBase64 = async(imageUrl) => {\n    const response = await fetch(imageUrl);\n    if (!response.ok) {\n        throw new Error('Failed to fetch image');\n    }\n    const blob = await response.blob();\n    return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onload = () => resolve(reader.result);\n        reader.onerror = () => reject(new Error('FileReader failed'));\n        reader.readAsDataURL(blob);\n    });\n};\n\n/**\n * Display error alert to user.\n *\n * @param {string} message Error message to display\n * @param {string|null} title Optional title for the alert\n */\nconst showErrorAlert = async(message, title = null) => {\n    if (title === null) {\n        title = await getString('generateerror', 'aiinjection_alttext');\n    }\n    await moodleAlert(title, message);\n};\n\n/**\n * Extract alt text from AI response\n *\n * @param {Object} data Response data from AI service\n * @returns {string|null} Extracted alt text or null\n */\nconst extractAltText = (data) => {\n    if (data?.error) {\n        return null;\n    }\n    const result = data?.result || data?.data?.result;\n    if (!result) {\n        return null;\n    }\n\n    // Strip HTML tags from result.\n    let text = result.replace(/<[^>]*>/g, '').trim();\n    // Attempt to decode escaped unicode characters.\n    try {\n        text = JSON.parse('\"' + text.replace(/\"/g, '\\\\\"') + '\"');\n    } catch (e) {\n        // Use original if JSON parsing fails.\n    }\n    return text || null;\n};\n\n/**\n * Generate alt text using AI service\n *\n * @param {string} imageUrl Image URL to process\n * @returns {Promise<string|null>} Generated alt text or null\n */\nconst generateAltText = async(imageUrl) => {\n    // Get current user language for the prompt.\n    const currentLanguage = getCurrentLanguage();\n\n    // Replace {LANGUAGE} placeholder in prompt template from PHP config.\n    const prompt = promptTemplate.replace('{LANGUAGE}', currentLanguage);\n\n    const imageBase64 = await imageToBase64(imageUrl);\n\n    const result = await makeRequest('itt', prompt, 'aiinjection_alttext', contextId, {image: imageBase64});\n\n    // Check for error response with code.\n    if (result?.code && result.code !== 200) {\n        const parsedResult = JSON.parse(result.result);\n        if (parsedResult.debuginfo) {\n            Log.error(parsedResult.debuginfo);\n        }\n        throw new Error(parsedResult.message || 'AI request failed');\n    }\n\n    return extractAltText(Array.isArray(result) ? result[0] : result);\n};\n\n/**\n * Button click handler\n *\n * @param {Event} event Click event\n */\nconst handleButtonClick = async(event) => {\n    event.preventDefault();\n    const button = event.target.closest('[data-action=\"generate-alttext\"]');\n    if (!button) {\n        return;\n    }\n    const modal = button.closest(\".modal\");\n    const textarea = modal.querySelector(\".tiny_image_altentry\");\n    const image = modal.querySelector(\".tiny_image_preview\");\n\n    if (!textarea || !image?.src || image.src === \"data:,\") {\n        return;\n    }\n\n    // Show loading state via template.\n    await injectButton(modal, {isloading: true});\n\n    try {\n        const altText = await generateAltText(image.src);\n        if (altText) {\n            textarea.value = altText;\n            textarea.dispatchEvent(new Event(\"input\", {bubbles: true}));\n            textarea.dispatchEvent(new Event(\"change\", {bubbles: true}));\n        }\n    } catch (error) {\n        Log.error(\"Alt text generation failed:\", error);\n        const errorMessage = await getString('generateerrorwithmessage', 'aiinjection_alttext', error.message);\n        await showErrorAlert(errorMessage);\n    }\n\n    // Reset to normal state via template.\n    await injectButton(modal, {isloading: false});\n};\n\n/**\n * Inject AI button into modal.\n *\n * Uses Templates.appendNodeContents for proper rendering and JS execution.\n * Handles disabled state by showing a disabled button with tooltip.\n *\n * @param {HTMLElement} modal Modal element to inject button into\n * @param {Object} templateContext Context object for template rendering (optional)\n */\nconst injectButton = async(modal, templateContext = {}) => {\n    // Use data attribute selector for the character count element.\n    const countspan = modal.querySelector('[data-region=\"character-count\"]') || modal.querySelector(\"#the-count\");\n    if (!countspan) {\n        return;\n    }\n\n    // Remove existing button if present.\n    const existingButton = modal.querySelector('[data-action=\"generate-alttext\"]');\n    if (existingButton) {\n        existingButton.remove();\n    }\n\n    // Add disabled state to template context if purpose is disabled.\n    if (isPurposeDisabled()) {\n        templateContext.isdisabled = true;\n        templateContext.disabledreason = getDisabledReason();\n    }\n\n    // Render template using Templates.appendNodeContents which handles JS execution.\n    const {html, js} = await Templates.renderForPromise('aiinjection_alttext/ai_button_container', templateContext);\n    countspan.insertAdjacentHTML(\"afterend\", html);\n    Templates.runTemplateJS(js);\n\n    // Only add event listener if not disabled.\n    const button = modal.querySelector('[data-action=\"generate-alttext\"]');\n    if (button && !isPurposeDisabled()) {\n        button.addEventListener('click', handleButtonClick);\n    }\n};\n\n/**\n * Initialize MutationObserver for modal detection.\n *\n * Watches for new modals being added to the DOM and injects the AI button.\n * Uses WeakSet to track initialized modals and prevent duplicate listeners.\n */\nconst initModalObserver = () => {\n    const observer = new MutationObserver((mutations) => {\n        mutations.forEach((mutation) => {\n            mutation.addedNodes.forEach((node) => {\n                if (node.nodeType === Node.ELEMENT_NODE) {\n                    // Check if added node is a modal with tiny_image_altentry.\n                    if (node.classList?.contains('modal') && node.querySelector('.tiny_image_altentry')) {\n                        if (!initializedModals.has(node)) {\n                            initializedModals.add(node);\n                            injectButton(node);\n                        }\n                    }\n                    // Check if added node contains a modal with tiny_image_altentry.\n                    const altentry = node.querySelector?.('.modal .tiny_image_altentry');\n                    if (altentry) {\n                        const modalElement = altentry.closest('.modal');\n                        if (modalElement && !initializedModals.has(modalElement)) {\n                            initializedModals.add(modalElement);\n                            injectButton(modalElement);\n                        }\n                    }\n                }\n            });\n        });\n    });\n\n    observer.observe(document.body, {\n        childList: true,\n        subtree: true\n    });\n};\n\n/**\n * Initialize AI alt text injection.\n *\n * @param {Object} config Configuration object from PHP containing aiconfig and contextid\n */\nexport const init = (config) => {\n    // Store AI configuration for later use.\n    aiConfig = config.aiconfig;\n    // Store context ID for AI requests (required for proper permission checks).\n    contextId = config.contextid || 0;\n    // Store prompt template from PHP.\n    promptTemplate = config.prompttemplate || '';\n\n    // Use MutationObserver for detecting dynamically added modals.\n    initModalObserver();\n\n    // Check for existing modals on page load.\n    const existingModals = document.querySelectorAll('.modal .tiny_image_altentry');\n    existingModals.forEach(textarea => {\n        const modal = textarea.closest('.modal');\n        if (modal && !initializedModals.has(modal)) {\n            initializedModals.add(modal);\n            injectButton(modal);\n        }\n    });\n};\n"],"names":["initializedModals","WeakSet","aiConfig","contextId","promptTemplate","isPurposeDisabled","_aiConfig","purposes","_aiConfig$purposes","available","getDisabledReason","disabledreason","generateAltText","async","currentLanguage","currentUserLanguage","Config","language","substring","Intl","DisplayNames","type","of","getCurrentLanguage","prompt","replace","imageBase64","response","fetch","imageUrl","ok","Error","blob","Promise","resolve","reject","reader","FileReader","onload","result","onerror","readAsDataURL","imageToBase64","image","code","parsedResult","JSON","parse","debuginfo","error","message","data","_data$data","text","trim","e","extractAltText","Array","isArray","handleButtonClick","event","preventDefault","button","target","closest","modal","textarea","querySelector","src","injectButton","isloading","altText","value","dispatchEvent","Event","bubbles","errorMessage","title","showErrorAlert","templateContext","countspan","existingButton","remove","isdisabled","html","js","Templates","renderForPromise","insertAdjacentHTML","runTemplateJS","addEventListener","config","aiconfig","contextid","prompttemplate","MutationObserver","mutations","forEach","mutation","addedNodes","node","nodeType","Node","ELEMENT_NODE","classList","contains","has","add","altentry","_node$querySelector","modalElement","observe","document","body","childList","subtree","querySelectorAll"],"mappings":"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"}