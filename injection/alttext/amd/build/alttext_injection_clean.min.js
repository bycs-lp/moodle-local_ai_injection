define("aiinjection_alttext/alttext_injection_clean",["exports","core/log","local_ai_manager/make_request"],(function(_exports,_log,_make_request){var obj;
/**
   * AI Alt Text injection module.
   *
   * This module provides functionality to inject AI-powered alt text generation
   * buttons into TinyMCE image dialogs and automatically process images.
   *
   * @module     aiinjection_alttext/alttext_injection
   * @copyright  2025 ISB Bayern
   * @author     Dr. Peter Mayer
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_log=(obj=_log)&&obj.__esModule?obj:{default:obj};_exports.init=config=>{const initializeApp=()=>{config.enabled&&processImages(config),initModalObserver(config)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeApp):initializeApp()};const findElement=(parent,selectors)=>{for(const selector of selectors){const element=parent.querySelector(selector);if(element)return element}return null},initModalObserver=config=>{checkForImageModal(document,config);new MutationObserver((mutations=>{mutations.forEach((mutation=>{"childList"===mutation.type&&mutation.addedNodes.length>0&&mutation.addedNodes.forEach((node=>{node.nodeType===Node.ELEMENT_NODE&&checkForImageModal(node,config)}))}))})).observe(document.body,{childList:!0,subtree:!0})},checkForImageModal=(node,config)=>{const altTextarea=findElement(node,["#_tiny_image_altentry.tiny_image_altentry","#_tiny_image_altentry",'textarea[name="altentry"]',"textarea.tiny_image_altentry"]);if(altTextarea){const rightColumn=findElement(node,[".tiny_image_properties_col",".col-lg-5",'[class*="properties"]']);rightColumn&&setTimeout((()=>injectAIButton(rightColumn,altTextarea,config)),100)}},injectAIButton=(rightColumn,altTextarea,config)=>{if(rightColumn.querySelector(".ai-alttext-button"))return;const imagePreview=findElement(document,[".tiny_image_preview",'img[src*="draftfile"]',".tiny_image_preview_box img",".tox-dialog img",'[role="dialog"] img',".mce-window img"]);if(null==imagePreview||!imagePreview.src)return;const buttonContainer=document.createElement("div");buttonContainer.className="ai-alttext-container mb-3 mt-3";const aiButton=document.createElement("button");Object.assign(aiButton,{type:"button",className:"btn btn-secondary ai-alttext-button",innerHTML:'<i class="fa fa-magic me-1"></i> KI-Bildbeschreibung generieren'}),aiButton.addEventListener("click",(async event=>{event.preventDefault(),await handleAIButtonClick(aiButton,altTextarea,imagePreview,config)})),buttonContainer.appendChild(aiButton),rightColumn.appendChild(buttonContainer)},handleAIButtonClick=async(button,textarea,imageElement,config)=>{const originalText=button.innerHTML;button.disabled=!0,button.innerHTML='<i class="fa fa-spinner fa-spin me-1"></i> Generiere Beschreibung...';try{const altText=await generateAltText(imageElement);altText?(textarea.value=altText,textarea.dispatchEvent(new Event("input",{bubbles:!0})),config.debug&&_log.default.debug("Alt text generated and inserted:",altText)):alert("Fehler beim Generieren der Bildbeschreibung. Bitte versuchen Sie es erneut.")}catch(error){config.debug&&_log.default.error("Error generating alt text:",error),alert("Fehler beim Generieren der Bildbeschreibung: "+error.message)}finally{button.disabled=!1,button.innerHTML=originalText}},processImages=config=>{const images=document.querySelectorAll(config.selector);config.debug&&_log.default.debug("Found ".concat(images.length," images to process")),images.forEach(((img,index)=>{setTimeout((()=>{processImage(img,config)}),500*index)}))},processImage=async(img,config)=>{try{img.setAttribute("data-ai-alttext-status","loading");const altText=await generateAltText(img);altText?(img.alt=altText,img.setAttribute("data-ai-alttext-status","completed"),config.debug&&_log.default.debug("Generated alt text for ".concat(img.src,": ").concat(altText))):img.setAttribute("data-ai-alttext-status","failed")}catch(error){img.setAttribute("data-ai-alttext-status","error"),config.debug&&_log.default.error("Error processing image:",error)}},generateAltText=async imageElement=>{try{const imageBase64=await(async imageElement=>new Promise(((resolve,reject)=>{try{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image;img.crossOrigin="anonymous",img.onload=()=>{canvas.width=img.naturalWidth||img.width,canvas.height=img.naturalHeight||img.height,ctx.drawImage(img,0,0);try{const dataURL=canvas.toDataURL("image/jpeg",.8);resolve(dataURL)}catch(error){_log.default.error("Canvas toDataURL error:",error),reject(error)}},img.onerror=error=>{_log.default.error("Image load error:",error),reject(error)},img.src=imageElement.src}catch(error){_log.default.error("Canvas creation error:",error),reject(error)}})))(imageElement),prompt="Generiere einen pr채zisen deutschen Alt-Text f체r das Bild. Beschreibe kurz und sachlich was auf dem Bild zu sehen ist. Der Alt-Text soll f체r sehbehinderte Personen verst채ndlich sein.",result=await(0,_make_request.makeRequest)("itt",prompt,"aiinjection_alttext",0,{image:imageBase64});let responseData=result;Array.isArray(result)&&result.length>0&&(responseData=result[0]);let altText=null;if(responseData&&!0===responseData.error)return _log.default.error("AI Manager returned error:",responseData),null;if(responseData&&responseData.data&&responseData.data.result){const htmlResult=responseData.data.result,tempDiv=document.createElement("div");tempDiv.innerHTML=htmlResult,altText=tempDiv.textContent||tempDiv.innerText||"",altText=altText.trim()}else if(responseData&&responseData.result){const htmlResult=responseData.result,tempDiv=document.createElement("div");tempDiv.innerHTML=htmlResult,altText=tempDiv.textContent||tempDiv.innerText||"",altText=altText.trim()}return altText||null}catch(error){return _log.default.error("Error in generateAltText (AI manager):",error),null}}}));

//# sourceMappingURL=alttext_injection_clean.min.js.map