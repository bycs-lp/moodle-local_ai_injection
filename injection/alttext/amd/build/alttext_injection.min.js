define("aiinjection_alttext/alttext_injection",["exports","core/log","core/str","local_ai_manager/make_request","core/templates"],(function(_exports,_log,_str,_make_request,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Ultra-optimized AI Alt Text injection for Tiny Media modals.
   *
   * @module     aiinjection_alttext/alttext_injection
   * @copyright  2025 ISB Bayern
   * @author     Dr. Peter Mayer
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_log=_interopRequireDefault(_log),_templates=_interopRequireDefault(_templates);const imageToBase64=imageUrl=>new Promise(((resolve,reject)=>{const img=new Image;img.crossOrigin="anonymous",img.onload=()=>{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=img.naturalWidth||img.width,canvas.height=img.naturalHeight||img.height,ctx.drawImage(img,0,0),resolve(canvas.toDataURL("image/jpeg",.8))},img.onerror=()=>reject(new Error("Image load failed")),img.src=imageUrl})),generateAltText=async imageUrl=>{try{const[imageBase64,prompt]=await Promise.all([imageToBase64(imageUrl),(0,_str.getString)("aiprompt","aiinjection_alttext")]),result=await(0,_make_request.makeRequest)("itt",prompt,"aiinjection_alttext",0,{image:imageBase64});return(data=>{var _data$data;if(null!=data&&data.error)return null;const result=(null==data?void 0:data.result)||(null==data||null===(_data$data=data.data)||void 0===_data$data?void 0:_data$data.result);if(!result)return null;let text=result.replace(/<[^>]*>/g,"").trim();try{text=JSON.parse('"'+text.replace(/"/g,'\\"')+'"')}catch(e){}return text||null})(Array.isArray(result)?result[0]:result)}catch(error){return _log.default.error("AI generation failed:",error),null}},handleButtonClick=async event=>{event.preventDefault();const modal=event.target.closest(".modal"),textarea=modal.querySelector(".tiny_image_altentry"),image=modal.querySelector(".tiny_image_preview");if(textarea&&null!=image&&image.src&&"data:,"!==image.src){await injectButton(modal,{isloading:!0});try{const altText=await generateAltText(image.src);altText&&(textarea.value=altText,textarea.dispatchEvent(new Event("input",{bubbles:!0})),textarea.dispatchEvent(new Event("change",{bubbles:!0})))}catch(error){_log.default.error("Button click error:",error)}await injectButton(modal,{isloading:!1})}},injectButton=async function(modal){let templateContext=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const countspan=modal.querySelector("#the-count");if(!countspan)return;let button=modal.querySelector(".ai-alttext-btn");button&&button.remove();const{html:html,js:js}=await _templates.default.renderForPromise("aiinjection_alttext/ai_button_container",templateContext);countspan.insertAdjacentHTML("afterend",html),js&&_templates.default.runTemplateJS(js),button=modal.querySelector(".ai-alttext-btn"),button&&button.addEventListener("click",handleButtonClick)};_exports.init=()=>{new MutationObserver((mutations=>{mutations.forEach((mutation=>{mutation.addedNodes.forEach((node=>{if(node.nodeType===Node.ELEMENT_NODE){var _node$classList,_node$querySelector;null!==(_node$classList=node.classList)&&void 0!==_node$classList&&_node$classList.contains("modal")&&node.querySelector(".tiny_image_altentry")&&setTimeout((()=>injectButton(node)),100);const modal=null===(_node$querySelector=node.querySelector)||void 0===_node$querySelector?void 0:_node$querySelector.call(node,".modal .tiny_image_altentry");if(modal){const modalElement=modal.closest(".modal");modalElement&&setTimeout((()=>injectButton(modalElement)),100)}}}))}))})).observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{document.querySelectorAll(".modal .tiny_image_altentry").forEach((textarea=>{const modal=textarea.closest(".modal");modal&&injectButton(modal)}))}),500)}}));

//# sourceMappingURL=alttext_injection.min.js.map