{"version":3,"file":"confirm_ai_usage.min.js","sources":["../src/confirm_ai_usage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AI usage confirmation modal.\n *\n * Provides functions to show a confirmation modal before AI features are used\n * and an info-only modal to review AI usage hints.\n *\n * @module     local_ai_injection/confirm_ai_usage\n * @copyright  2026 ISB Bayern\n * @author     Thomas Sch√∂nlein\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {renderInfoBox} from 'local_ai_manager/infobox';\nimport {renderWarningBox} from 'local_ai_manager/warningbox';\nimport Modal from 'core/modal';\nimport ModalEvents from 'core/modal_events';\nimport LocalStorage from 'core/localstorage';\nimport {userId} from 'core/config';\n\nconst STORAGE_KEY_PREFIX = 'local_ai_injection_ai_confirmed_';\n\n/**\n * Hash a string using SHA-256.\n *\n * @param {string} stringToHash the string to hash\n * @returns {Promise<string>} hex representation of the SHA-256 hash\n */\nconst hash = async(stringToHash) => {\n    const data = new TextEncoder().encode(stringToHash);\n    const hashAsArrayBuffer = await window.crypto.subtle.digest('SHA-256', data);\n    const uint8ViewOfHash = new Uint8Array(hashAsArrayBuffer);\n    return Array.from(uint8ViewOfHash)\n        .map((b) => b.toString(16).padStart(2, '0'))\n        .join('');\n};\n\n/**\n * Get the hashed storage key for the current user.\n *\n * @returns {Promise<string>} hashed storage key\n */\nconst getStorageKey = async() => {\n    return hash(STORAGE_KEY_PREFIX + userId);\n};\n\n/**\n * Check if the user has already confirmed AI usage.\n *\n * @returns {Promise<boolean>} true if confirmed\n */\nexport const isAiUsageConfirmed = async() => {\n    const key = await getStorageKey();\n    return LocalStorage.get(key) === '1';\n};\n\nclass ConfirmModal extends Modal {\n     static TYPE = 'local_ai_injection/confirm_ai_usage_modal';\n     static TEMPLATE = 'local_ai_injection/confirm_ai_usage_modal';\n\n    configure(modalConfig) {\n        modalConfig.removeOnClose = true;\n        this.registerCloseOnCancel();\n        this.registerCloseOnSave();\n        super.configure(modalConfig);\n    }\n}\n\n/**\n * Show a confirmation modal for AI usage on first use per session.\n *\n * @param {string} component the component from which the request is being done\n * @param {array} purposes the purpose to use for the request\n * @returns {Promise<boolean>} True if user confirmed, false if canceled\n */\n\nexport const confirmAiUsage = async(component, purposes = []) => {\n\n    const storageKey = await getStorageKey();\n\n    if (LocalStorage.get(storageKey) === '1') {\n        return true;\n    }\n\n    const modal = await ConfirmModal.create({show: true, templateContext: {infoonly: false}});\n    const container = modal.getBody()[0].querySelector('.local_ai_injection-confirm-content');\n\n    await renderInfoBox(component, userId, container, purposes);\n    await renderWarningBox(container);\n\n    return new Promise(resolve => {\n        modal.getRoot().on(ModalEvents.save, () => {\n            LocalStorage.set(storageKey, '1');\n            resolve(true);\n            modal.destroy();\n        });\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            resolve(false);\n        });\n    });\n\n};\n\n/**\n * Show an info-only modal displaying AI usage hints without requiring confirmation.\n *\n * @param {string} component the component from which the request is being done\n * @param {array} purposes the purpose to use for the request\n */\nexport const showAiInfo = async(component, purposes = []) => {\n    const modal = await ConfirmModal.create({show: true, templateContext: {infoonly: true}});\n    const container = modal.getBody()[0].querySelector('.local_ai_injection-confirm-content');\n\n    await renderInfoBox(component, userId, container, purposes);\n    await renderWarningBox(container);\n};\n"],"names":["getStorageKey","async","data","TextEncoder","encode","stringToHash","hashAsArrayBuffer","window","crypto","subtle","digest","uint8ViewOfHash","Uint8Array","Array","from","map","b","toString","padStart","join","hash","userId","key","LocalStorage","get","ConfirmModal","Modal","configure","modalConfig","removeOnClose","registerCloseOnCancel","registerCloseOnSave","component","purposes","storageKey","modal","create","show","templateContext","infoonly","container","getBody","querySelector","Promise","resolve","getRoot","on","ModalEvents","save","set","destroy","hidden"],"mappings":"0xBAuDMA,cAAgBC,SAdTA,OAAAA,qBACHC,MAAO,IAAIC,aAAcC,OAAOC,cAChCC,wBAA0BC,OAAOC,OAAOC,OAAOC,OAAO,UAAWR,MACjES,gBAAkB,IAAIC,WAAWN,0BAChCO,MAAMC,KAAKH,iBACbI,KAAKC,GAAMA,EAAEC,SAAS,IAAIC,SAAS,EAAG,OACtCC,KAAK,KASHC,CAvBgB,mCAuBUC,4CAQHpB,gBACxBqB,UAAYtB,sBACe,MAA1BuB,sBAAaC,IAAIF,YAGtBG,qBAAqBC,eAIvBC,UAAUC,aACNA,YAAYC,eAAgB,OACvBC,6BACAC,4BACCJ,UAAUC,8BARlBH,oBACa,6DADbA,wBAEiB,qEAkBOxB,eAAM+B,eAAWC,gEAAW,SAEhDC,iBAAmBlC,mBAEY,MAAjCuB,sBAAaC,IAAIU,mBACV,QAGLC,YAAcV,aAAaW,OAAO,CAACC,MAAM,EAAMC,gBAAiB,CAACC,UAAU,KAC3EC,UAAYL,MAAMM,UAAU,GAAGC,cAAc,oDAE7C,0BAAcV,UAAWX,eAAQmB,UAAWP,gBAC5C,gCAAiBO,WAEhB,IAAIG,SAAQC,UACfT,MAAMU,UAAUC,GAAGC,sBAAYC,MAAM,2BACpBC,IAAIf,WAAY,KAC7BU,SAAQ,GACRT,MAAMe,aAEVf,MAAMU,UAAUC,GAAGC,sBAAYI,QAAQ,KACnCP,SAAQ,8BAYM3C,eAAM+B,eAAWC,gEAAW,SAC5CE,YAAcV,aAAaW,OAAO,CAACC,MAAM,EAAMC,gBAAiB,CAACC,UAAU,KAC3EC,UAAYL,MAAMM,UAAU,GAAGC,cAAc,6CAE7C,0BAAcV,UAAWX,eAAQmB,UAAWP,gBAC5C,gCAAiBO"}